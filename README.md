# notifications

Notification web service для обработки webhook запросов от YouTrack и отправки уведомлений через различные каналы (Telegram, Logger).

## Возможности

- Обработка webhook запросов от YouTrack
- Отправка уведомлений через Telegram и Logger каналы
- Настройка проектов YouTrack и разрешенных каналов уведомлений для каждого проекта
- Приватность проектов: каждый проект использует свой `chat_id` для Telegram

## Конфигурация

### Структура конфигурации

Приложение использует YAML файл конфигурации (по умолчанию `./config/config.yml`). Путь можно переопределить через переменную окружения `CONFIG_PATH`.

Пример конфигурации:

```yaml
http:
  addr: ":3000"
  shutdown_timeout: 5
  read_timeout: 5
  write_timeout: 5

telegram:
  bot_token: "your_bot_token"  # Глобальный токен бота (обязателен, если используется Telegram)
  timeout: 10                  # Таймаут для HTTP запросов к Telegram API (секунды)

logger:
  level: "debug"

notifications:
  youtrack:
    projects:  # ⚠️ Ключ "projects" обязателен!
      projectName1:  # Имя проекта в нижнем регистре (рекомендуется)
        allowedChannels: [telegram, logger]
        telegram:
          chat_id: "123456789"  # Обязательно, если telegram в allowedChannels
      projectName2:
        allowedChannels: [logger]
      projectName3:
        allowedChannels: [telegram]
        telegram:
          chat_id: "987654321"
```

**Важные замечания:**

1. **Ключ `projects` обязателен:** Проекты должны быть указаны под ключом `projects` внутри `youtrack`. Неправильно: `youtrack: DEMO: ...`. Правильно: `youtrack: projects: DEMO: ...`

2. **Нормализация регистра:** Если в YouTrack проект называется "DEMO" (верхний регистр), в конфигурации его можно указать как `demo`, `DEMO` или `Demo` - все варианты будут работать одинаково благодаря нормализации регистра. После загрузки конфигурации все ключи проектов автоматически приводятся к нижнему регистру.

### Настройка проектов

Каждый проект YouTrack должен быть настроен в секции `notifications.youtrack.projects`:

- **`allowedChannels`** - список разрешенных каналов уведомлений:
  - `telegram` - отправка через Telegram
  - `logger` - логирование уведомлений
- **`telegram.chat_id`** - обязателен, если `telegram` в `allowedChannels`

**Важно:** Имена проектов нормализуются к нижнему регистру при загрузке конфигурации и при обработке webhook. Это означает, что проекты "DEMO", "Demo" и "demo" будут обрабатываться одинаково. В конфигурации можно указать проект в любом регистре, но рекомендуется использовать нижний регистр для единообразия.

### Поведение

- Если настройки для проекта не существуют, то уведомление игнорируется, при этом пишется запись в лог через системный логгер
- Если настройки существуют, то используются только разрешенные каналы
- Для Telegram канала: **обязательно** используется `chat_id` из настроек проекта (приватность проектов)
- Глобальный `chat_id` больше не используется (только `bot_token` и `timeout` остаются глобальными)

### Логирование и отладка

Приложение логирует важную информацию для отладки:

- **При старте:** Список всех загруженных проектов:
  ```
  {"level":"info","msg":"Loaded project configurations","projects":["demo","project2"],"count":2}
  ```
  Если проекты не найдены:
  ```
  {"level":"warning","msg":"No project configurations found in config file"}
  ```

- **При обработке webhook:** Если проект не найден, в debug-логах будет список доступных проектов:
  ```
  {"level":"debug","msg":"Project not found in configuration","project":"DEMO","project_normalized":"demo","available_projects":["demo","project2"]}
  ```

- **Нормализация регистра:** В логах отображаются как оригинальное, так и нормализованное имя проекта для удобства отладки.

## Переменные окружения

Конфигурацию можно переопределить через переменные окружения (приоритет над YAML):

- `CONFIG_PATH` - путь к файлу конфигурации
- `HTTP_ADDR` - адрес HTTP сервера
- `HTTP_SHUTDOWN_TIMEOUT` - таймаут graceful shutdown (секунды)
- `HTTP_READ_TIMEOUT` - таймаут чтения запроса (секунды)
- `HTTP_WRITE_TIMEOUT` - таймаут записи ответа (секунды)
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота
- `TELEGRAM_TIMEOUT` - таймаут для HTTP запросов к Telegram API (секунды)
- `LOG_LEVEL` - уровень логирования (debug, info, warn, error)

## Запуск

```bash
go run cmd/server/main.go
```

## Тестирование

```bash
go test ./...
```

### Особенности реализации

- **Регистронезависимое сравнение проектов:** Все имена проектов нормализуются к нижнему регистру при загрузке конфигурации и при обработке webhook
- **Приватность проектов:** Каждый проект использует свой `chat_id` для Telegram, что обеспечивает изоляцию уведомлений между проектами
- **Гибкая конфигурация:** Поддержка как YAML файлов, так и переменных окружения (приоритет у ENV)
